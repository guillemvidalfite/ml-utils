---------------------------------------
---------------------------------------
-- DATASETS INFO
---------------------------------------
---------------------------------------
insert into datasets_info (dataset_alias,extensionid,studid,uniqueid,filename,round)
values ('ds1','620168_213_1_2_1_1_1_2','620168','h902-130tsb401-kf130.m050g9sub64sps4.1.1','050-213-Z1-UB64-130-400-401-1.1-620168_213_1_2_1_1_1_2.csv',1);

insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds1', '610063_213_1_1_1_2_1_1', '610063', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds2', '610063_213_3_1_1_2_1_1', '610063', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds3', '610319_213_3_1_1_2_1_1', '610319', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds4', '610352_213_1_1_1_2_1_1', '610352', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds5', '610490_213_3_1_1_2_1_1', '610490', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds6', '610502_213_3_1_1_2_1_1', '610502', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds8', '610580_213_3_1_1_1_1_1', '610580', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds9', '610582_213_1_1_1_1_1_2', '610582', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds10', '610582_213_3_1_1_2_1_1', '610582', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds11', '610583_213_1_1_1_1_1_2', '610583', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds12', '610586_213_1_1_1_2_1_1', '610586', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds13', '610630_213_1_1_1_1_1_1', '610630', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds14', '610630_213_1_1_1_2_1_1', '610630', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds15', '610631_213_1_1_1_1_1_1', '610631', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds16', '610631_213_1_1_1_2_1_1', '610631', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds17', '610638_213_1_1_1_2_1_1', '610638', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds18', '610638_213_3_1_1_2_1_1', '610638', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds19', '610640_213_1_1_1_1_1_1', '610640', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds21', '610649_213_1_1_1_1_1_1', '610649', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds22', '610653_213_1_1_1_2_1_1', '610653', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds23', '610653_213_1_2_1_2_1_1', '610653', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds24', '610727_213_1_1_1_1_1_1', '610727', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds25', '610748_213_1_1_1_2_1_1', '610748', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds26', '610760_213_3_1_1_2_1_1', '610760', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds28', '610761_213_1_1_1_2_1_1', '610761', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds29', '610761_213_3_1_1_2_1_1', '610761', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds30', '610762_213_3_1_1_2_1_1', '610762', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds32', '610871_213_3_1_1_1_1_1', '610871', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds33', '610871_213_3_1_1_2_1_1', '610871', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds34', '610873_213_3_1_1_2_1_2', '610873', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds35', '610980_213_1_1_1_1_1_1', '610980', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds36', '610994_213_1_1_1_1_1_1', '610994', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds41', '611382_213_1_2_1_1_1_1', '611382', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds42', '611382_213_3_1_1_2_1_1', '611382', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds43', '620239_213_1_1_1_1_1_1', '620239', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds44', '620321_213_3_1_1_1_1_1', '620321', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds48', '620420_213_1_1_1_2_1_1', '620420', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds49', '620422_213_1_2_1_1_1_1', '620422', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds50', '620422_213_1_2_1_2_1_1', '620422', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds51', '620422_213_3_2_1_2_1_1', '620422', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds54', '620480_213_3_1_1_2_1_1', '620480', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds56', '620504_213_3_1_1_2_1_1', '620504', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds57', '620520_213_3_1_1_2_1_1', '620520', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds58', '620558_213_1_2_1_2_1_1', '620558', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds59', '620558_213_3_2_1_2_1_1', '620558', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds60', '620645_213_1_1_1_1_1_1', '620645', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds61', '620645_213_1_1_1_2_1_2', '620645', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds62', '620667_213_1_1_1_2_1_2', '620667', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds63', '620671_213_1_2_1_2_1_1', '620671', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds68', '620776_213_1_1_1_2_1_1', '620776', 2);
insert into datasets_info (dataset_alias,extensionid,studid,round) values ('ds69', '620776_213_3_1_1_2_1_1', '620776', 2);

update datasets_info a set uniqueid = (select distinct "uniqueID" from welds_70_datasets b where b.extensionid = a.extensionid);


alter table datasets_info add total_errors integer;
alter table datasets_info add total_welds integer;

update datasets_info a set total_errors = (select count(1) from welds_70_datasets b where a.extensionid = b.extensionid and b.error = 1);
update datasets_info a set total_welds = (select count(1) from welds_70_datasets b where a.extensionid = b.extensionid);
-- select i.dataset_alias, i.extensionid, i.uniqueid, count(1) as total_welds, count(a.error > 0) as total_errors
-- from datasets_info i, welds_70_datasets a
-- where i.extensionid = a.extensionid
-- group by i.dataset_alias, i.extensionid, i.uniqueid;




---------------------------------------------------
---------------------------------------------------
-- ADD REPAIR FLAGS 
---------------------------------------------------
---------------------------------------------------
alter table welds_70_datasets add column bodyshop_repair integer;
alter table welds_70_datasets add column assembly_repair integer;
alter table welds_70_datasets add column error integer;

--update welds_70_datasets set bodyshop_repair = null;
--update welds_70_datasets set assembly_repair = null;
--update welds_70_datasets set error = null;

update welds_70_datasets a set bodyshop_repair = 1 where exists (select 1 from bodyshop_repairs b where b.carbodyid = substring(a."CarbodyID",1,7) and substring(b.studid,1,6) = a."StudID");
update welds_70_datasets a set bodyshop_repair = 0 where bodyshop_repair is null;

/*select count(1) 
from welds_70_datasets a, bodyshop_repairs b
where b.carbodyid = substring(a."CarbodyID",1,7) and
      substring(b.studid,1,6) = a."StudID";

select length(carbodyid), count(1) from bodyshop_repairs group by length(carbodyid);
select length(carbodyid), count(1) from assembly_repairs group by length(carbodyid);
select length("CarbodyID"), count(1) from welds_70_datasets group by length("CarbodyID");


select count(1) 
from welds_70_datasets a, assembly_repairs b
where b.carbodyid = substring(a."CarbodyID",1,7) and
      b.studid = a."StudID";


select length(studid), count(1) from bodyshop_repairs group by length(studid);
select length(carbodyid), count(1) from assembly_repairs group by length(carbodyid);
select length("CarbodyID"), count(1) from welds_70_datasets group by length("CarbodyID");
*/

update welds_70_datasets a set assembly_repair = 1 where exists (select 1 from assembly_repairs b where b.carbodyid = substring(a."CarbodyID",1,7) and b.studid = a."StudID");
update welds_70_datasets a set assembly_repair = 0 where assembly_repair is null;


update welds_70_datasets a set error = 1 where assembly_repair = 1 or bodyshop_repair = 1;
update welds_70_datasets a set error = 0 where error is null;

-- TEST
/*drop table if exists repair_flags;
create table repair_flags(
     fingerprint varchar(100),
     bodyshop_repair varchar(1),
     assemblyshop_repair varchar(1),
     repaired varchar(1)
);

copy repair_flags(
        fingerprint,
        bodyshop_repair,
        assemblyshop_repair,
        repaired
)FROM '/Users/guillem/Data/Customers/Daimler/70_datasets_alvaro_v2/repair_flags.csv' DELIMITER ',' CSV HEADER;

create index inx_repairflags_fingerpring on repair_flags(fingerprint);


--alter table welds_70_datasets add column error2 integer;
--update welds_70_datasets a set error2 = (select case b.repaired when 'f' then 0 when 't' then 1 end from repair_flags b where b.fingerprint = a.fingerprint);
--select error2, error, count(1) from welds_70_datasets group by error2, error order by 1,2;
alter table welds_70_datasets drop column error2;*/

---------------------------------------------------
---------------------------------------------------
---------------------------------------------------
------- WELDS NEW FIELDS
---------------------------------------------------
---------------------------------------------------
---------------------------------------------------
drop table if exists welds_70_current_stats;
create table welds_70_current_stats(
      fingerprint varchar(100),
      extensionid varchar(100),
      uniqueid varchar(100),
      penetration_avg_distance numeric,
      penetration_up_limit_distance numeric,
      penetration_low_limit_distance numeric,
      penetration_offsigma_distance numeric,
      energy_avg_distance numeric,
      energy_up_limit_distance numeric,
      energy_low_limit_distance numeric,
      energy_offsigma_distance numeric,
      drop_time_avg_distance numeric,
      drop_time_up_limit_distance numeric,
      drop_time_low_limit_distance numeric,
      drop_time_offsigma_distance numeric,
      stickout_avg_distance numeric,
      stickout_up_limit_distance numeric,
      stickout_low_limit_distance numeric,
      stickout_offsigma_distance numeric,
      lift_avg_distance numeric,
      lift_up_limit_distance numeric,
      lift_low_limit_distance numeric,
      lift_offsigma_distance numeric,
      time_avg_distance numeric,
      time_up_limit_distance numeric,
      time_low_limit_distance numeric,
      time_offsigma_distance numeric,
      current_avg_distance numeric,
      current_up_limit_distance numeric,
      current_low_limit_distance numeric,
      current_offsigma_distance numeric,
      voltage_avg_distance numeric,
      voltage_up_limit_distance numeric,
      voltage_low_limit_distance numeric,
      voltage_offsigma_distance numeric
);

-- initial insert
insert into welds_70_current_stats (fingerprint, extensionid, uniqueid)
select a.fingerprint, a.extensionid, a."uniqueID"
from welds_70_datasets a;

-- penetration avg distance update
update welds_70_current_stats a set penetration_avg_distance = 
	(select round((c."LMPenetrationActual" - b.penetration_avg)/abs(b.penetration_avg),6)
	 from weld_averages b, welds_70_datasets c
	 where a.fingerprint = c.fingerprint and
	       b.key_tool = c."uniqueID" and 
	       b.key_extension = c.extensionid and 
	       extract(YEAR from c.weld_timestamp) = extract(YEAR from b.key_period) and
	       extract(MONTH from c.weld_timestamp) = extract(MONTH from b.key_period));

-- penetration up limit distance
update welds_70_current_stats a set penetration_up_limit_distance = 
	(select round((c."LMPenetrationActual" - b.penetration_up_2sig)/abs(b.penetration_up_2sig - b.penetration_avg),6)
	 from weld_averages b, welds_70_datasets c
	 where a.fingerprint = c.fingerprint and
	       b.key_tool = c."uniqueID" and 
	       b.key_extension = c.extensionid and 
	       extract(YEAR from c.weld_timestamp) = extract(YEAR from b.key_period) and
	       extract(MONTH from c.weld_timestamp) = extract(MONTH from b.key_period) and
	       c."LMPenetrationActual" > b.penetration_up_2sig and
	       b.penetration_up_2sig > b.penetration_avg);

-- penetration low limit distance
update welds_70_current_stats a set penetration_low_limit_distance = 
	(select round((b.penetration_low_2sig - c."LMPenetrationActual")/abs(b.penetration_avg - b.penetration_low_2sig),6)
	 from weld_averages b, welds_70_datasets c
	 where a.fingerprint = c.fingerprint and
	       b.key_tool = c."uniqueID" and 
	       b.key_extension = c.extensionid and 
	       extract(YEAR from c.weld_timestamp) = extract(YEAR from b.key_period) and
	       extract(MONTH from c.weld_timestamp) = extract(MONTH from b.key_period) and
	       c."LMPenetrationActual" < b.penetration_low_2sig and
	       b.penetration_low_2sig < b.penetration_avg);

-- energy avg distance update
update welds_70_current_stats a set energy_avg_distance = 
	(select round((c."WeldEnergyActual" - b.enery_avg)/abs(b.enery_avg),6)
	 from weld_averages b, welds_70_datasets c
	 where a.fingerprint = c.fingerprint and
	       b.key_tool = c."uniqueID" and 
	       b.key_extension = c.extensionid and 
	       extract(YEAR from c.weld_timestamp) = extract(YEAR from b.key_period) and
	       extract(MONTH from c.weld_timestamp) = extract(MONTH from b.key_period));

-- energy up limit distance
update welds_70_current_stats a set energy_up_limit_distance = 
	(select round((c."WeldEnergyActual" - b.energy_up_2sig)/abs(b.energy_up_2sig - b.enery_avg),6)
	 from weld_averages b, welds_70_datasets c
	 where a.fingerprint = c.fingerprint and
	       b.key_tool = c."uniqueID" and 
	       b.key_extension = c.extensionid and 
	       extract(YEAR from c.weld_timestamp) = extract(YEAR from b.key_period) and
	       extract(MONTH from c.weld_timestamp) = extract(MONTH from b.key_period) and
	       c."WeldEnergyActual" > b.energy_up_2sig and
	       b.energy_up_2sig > b.enery_avg);

-- energy low limit distance
update welds_70_current_stats a set energy_low_limit_distance = 
	(select round((b.energy_low_2sig - c."WeldEnergyActual")/abs(b.enery_avg - b.energy_low_2sig),6)
	 from weld_averages b, welds_70_datasets c
	 where a.fingerprint = c.fingerprint and
	       b.key_tool = c."uniqueID" and 
	       b.key_extension = c.extensionid and 
	       extract(YEAR from c.weld_timestamp) = extract(YEAR from b.key_period) and
	       extract(MONTH from c.weld_timestamp) = extract(MONTH from b.key_period) and
	       c."WeldEnergyActual" < b.energy_low_2sig and
	       b.energy_low_2sig < b.enery_avg);


-- drop_time avg distance update
update welds_70_current_stats a set drop_time_avg_distance = 
	(select round((c."DropTimeActual" - b.drop_time_avg)/abs(b.drop_time_avg),6)
	 from weld_averages b, welds_70_datasets c
	 where a.fingerprint = c.fingerprint and
	       b.key_tool = c."uniqueID" and 
	       b.key_extension = c.extensionid and 
	       extract(YEAR from c.weld_timestamp) = extract(YEAR from b.key_period) and
	       extract(MONTH from c.weld_timestamp) = extract(MONTH from b.key_period));

-- drop_time up limit distance
update welds_70_current_stats a set drop_time_up_limit_distance = 
	(select round((c."DropTimeActual" - b.drop_time_up_2sig)/abs(b.drop_time_up_2sig - b.drop_time_avg),6)
	 from weld_averages b, welds_70_datasets c
	 where a.fingerprint = c.fingerprint and
	       b.key_tool = c."uniqueID" and 
	       b.key_extension = c.extensionid and 
	       extract(YEAR from c.weld_timestamp) = extract(YEAR from b.key_period) and
	       extract(MONTH from c.weld_timestamp) = extract(MONTH from b.key_period) and
	       c."DropTimeActual" > b.drop_time_up_2sig and
	       b.drop_time_up_2sig > b.drop_time_avg);

-- drop_time low limit distance
update welds_70_current_stats a set drop_time_low_limit_distance = 
	(select round((b.drop_time_low_2sig - c."DropTimeActual")/abs(b.drop_time_avg - b.drop_time_low_2sig),6)
	 from weld_averages b, welds_70_datasets c
	 where a.fingerprint = c.fingerprint and
	       b.key_tool = c."uniqueID" and 
	       b.key_extension = c.extensionid and 
	       extract(YEAR from c.weld_timestamp) = extract(YEAR from b.key_period) and
	       extract(MONTH from c.weld_timestamp) = extract(MONTH from b.key_period) and
	       c."DropTimeActual" < b.drop_time_low_2sig and
	       b.drop_time_low_2sig < b.drop_time_avg);

-- stickout avg distance update
update welds_70_current_stats a set stickout_avg_distance = 
	(select round((c."StickoutActual" - b.stickout_avg)/abs(b.stickout_avg),6)
	 from weld_averages b, welds_70_datasets c
	 where a.fingerprint = c.fingerprint and
	       b.key_tool = c."uniqueID" and 
	       b.key_extension = c.extensionid and 
	       extract(YEAR from c.weld_timestamp) = extract(YEAR from b.key_period) and
	       extract(MONTH from c.weld_timestamp) = extract(MONTH from b.key_period));

-- stickout up limit distance
update welds_70_current_stats a set stickout_up_limit_distance = 
	(select round((c."StickoutActual" - b.stickout_up_2sig)/abs(b.stickout_up_2sig - b.stickout_avg),6)
	 from weld_averages b, welds_70_datasets c
	 where a.fingerprint = c.fingerprint and
	       b.key_tool = c."uniqueID" and 
	       b.key_extension = c.extensionid and 
	       extract(YEAR from c.weld_timestamp) = extract(YEAR from b.key_period) and
	       extract(MONTH from c.weld_timestamp) = extract(MONTH from b.key_period) and
	       c."StickoutActual" > b.stickout_up_2sig and
	       b.stickout_up_2sig > b.stickout_avg);

-- stickout low limit distance
update welds_70_current_stats a set stickout_low_limit_distance = 
	(select round((b.stickout_low_2sig - c."StickoutActual")/abs(b.stickout_avg - b.stickout_low_2sig),6)
	 from weld_averages b, welds_70_datasets c
	 where a.fingerprint = c.fingerprint and
	       b.key_tool = c."uniqueID" and 
	       b.key_extension = c.extensionid and 
	       extract(YEAR from c.weld_timestamp) = extract(YEAR from b.key_period) and
	       extract(MONTH from c.weld_timestamp) = extract(MONTH from b.key_period) and
	       c."StickoutActual" < b.stickout_low_2sig and
	       b.stickout_low_2sig < b.stickout_avg);

-- lift avg distance update
update welds_70_current_stats a set lift_avg_distance = 
	(select round((c."LMLiftHeightActual" - b.lift_avg)/abs(b.lift_avg),6)
	 from weld_averages b, welds_70_datasets c
	 where a.fingerprint = c.fingerprint and
	       b.key_tool = c."uniqueID" and 
	       b.key_extension = c.extensionid and 
	       extract(YEAR from c.weld_timestamp) = extract(YEAR from b.key_period) and
	       extract(MONTH from c.weld_timestamp) = extract(MONTH from b.key_period));

-- lift up limit distance
update welds_70_current_stats a set lift_up_limit_distance = 
	(select round((c."LMLiftHeightActual" - b.lift_up_2sig)/abs(b.lift_up_2sig - b.lift_avg),6)
	 from weld_averages b, welds_70_datasets c
	 where a.fingerprint = c.fingerprint and
	       b.key_tool = c."uniqueID" and 
	       b.key_extension = c.extensionid and 
	       extract(YEAR from c.weld_timestamp) = extract(YEAR from b.key_period) and
	       extract(MONTH from c.weld_timestamp) = extract(MONTH from b.key_period) and
	       c."LMLiftHeightActual" > b.lift_up_2sig and
	       b.lift_up_2sig > b.lift_avg);

-- lift low limit distance
update welds_70_current_stats a set lift_low_limit_distance = 
	(select round((b.lift_low_2sig - c."LMLiftHeightActual")/abs(b.lift_avg - b.lift_low_2sig),6)
	 from weld_averages b, welds_70_datasets c
	 where a.fingerprint = c.fingerprint and
	       b.key_tool = c."uniqueID" and 
	       b.key_extension = c.extensionid and 
	       extract(YEAR from c.weld_timestamp) = extract(YEAR from b.key_period) and
	       extract(MONTH from c.weld_timestamp) = extract(MONTH from b.key_period) and
	       c."LMLiftHeightActual" < b.lift_low_2sig and
	       b.lift_low_2sig < b.lift_avg);

-- time avg distance update
update welds_70_current_stats a set time_avg_distance = 
	(select round((c."WeldTimeActual" - b.time_avg)/abs(b.time_avg),6)
	 from weld_averages b, welds_70_datasets c
	 where a.fingerprint = c.fingerprint and
	       b.key_tool = c."uniqueID" and 
	       b.key_extension = c.extensionid and 
	       extract(YEAR from c.weld_timestamp) = extract(YEAR from b.key_period) and
	       extract(MONTH from c.weld_timestamp) = extract(MONTH from b.key_period));

-- time up limit distance
update welds_70_current_stats a set time_up_limit_distance = 
	(select round((c."WeldTimeActual" - b.time_up_2sig)/abs(b.time_up_2sig - b.time_avg),6)
	 from weld_averages b, welds_70_datasets c
	 where a.fingerprint = c.fingerprint and
	       b.key_tool = c."uniqueID" and 
	       b.key_extension = c.extensionid and 
	       extract(YEAR from c.weld_timestamp) = extract(YEAR from b.key_period) and
	       extract(MONTH from c.weld_timestamp) = extract(MONTH from b.key_period) and
	       c."WeldTimeActual" > b.time_up_2sig and
	       b.time_up_2sig > b.time_avg);

-- time low limit distance
update welds_70_current_stats a set time_low_limit_distance = 
	(select round((b.time_low_2sig - c."WeldTimeActual")/abs(b.time_avg - b.time_low_2sig),6)
	 from weld_averages b, welds_70_datasets c
	 where a.fingerprint = c.fingerprint and
	       b.key_tool = c."uniqueID" and 
	       b.key_extension = c.extensionid and 
	       extract(YEAR from c.weld_timestamp) = extract(YEAR from b.key_period) and
	       extract(MONTH from c.weld_timestamp) = extract(MONTH from b.key_period) and
	       c."WeldTimeActual" < b.time_low_2sig and
	       b.time_low_2sig < b.time_avg);

-- current avg distance update
update welds_70_current_stats a set current_avg_distance = 
	(select round((c."WeldCurrentActualPositive" - b.current_avg)/abs(b.current_avg),6)
	 from weld_averages b, welds_70_datasets c
	 where a.fingerprint = c.fingerprint and
	       b.key_tool = c."uniqueID" and 
	       b.key_extension = c.extensionid and 
	       extract(YEAR from c.weld_timestamp) = extract(YEAR from b.key_period) and
	       extract(MONTH from c.weld_timestamp) = extract(MONTH from b.key_period));

-- current up limit distance
update welds_70_current_stats a set current_up_limit_distance = 
	(select round((c."WeldCurrentActualPositive" - b.current_up_2sig)/abs(b.current_up_2sig - b.current_avg),6)
	 from weld_averages b, welds_70_datasets c
	 where a.fingerprint = c.fingerprint and
	       b.key_tool = c."uniqueID" and 
	       b.key_extension = c.extensionid and 
	       extract(YEAR from c.weld_timestamp) = extract(YEAR from b.key_period) and
	       extract(MONTH from c.weld_timestamp) = extract(MONTH from b.key_period) and
	       c."WeldCurrentActualPositive" > b.current_up_2sig and
	       b.current_up_2sig > b.current_avg);

-- current low limit distance
update welds_70_current_stats a set current_low_limit_distance = 
	(select round((b.current_low_2sig - c."WeldCurrentActualPositive")/abs(b.current_avg - b.current_low_2sig),6)
	 from weld_averages b, welds_70_datasets c
	 where a.fingerprint = c.fingerprint and
	       b.key_tool = c."uniqueID" and 
	       b.key_extension = c.extensionid and 
	       extract(YEAR from c.weld_timestamp) = extract(YEAR from b.key_period) and
	       extract(MONTH from c.weld_timestamp) = extract(MONTH from b.key_period) and
	       c."WeldCurrentActualPositive" < b.current_low_2sig and
	       b.current_low_2sig < b.current_avg);

-- voltage avg distance update
update welds_70_current_stats a set voltage_avg_distance = 
	(select round((c."WeldVoltageActual" - b.voltage_avg)/abs(b.voltage_avg),6)
	 from weld_averages b, welds_70_datasets c
	 where a.fingerprint = c.fingerprint and
	       b.key_tool = c."uniqueID" and 
	       b.key_extension = c.extensionid and 
	       extract(YEAR from c.weld_timestamp) = extract(YEAR from b.key_period) and
	       extract(MONTH from c.weld_timestamp) = extract(MONTH from b.key_period));

-- voltage up limit distance
update welds_70_current_stats a set voltage_up_limit_distance = 
	(select round((c."WeldVoltageActual" - b.voltage_up_2sig)/abs(b.voltage_up_2sig - b.voltage_avg),6)
	 from weld_averages b, welds_70_datasets c
	 where a.fingerprint = c.fingerprint and
	       b.key_tool = c."uniqueID" and 
	       b.key_extension = c.extensionid and 
	       extract(YEAR from c.weld_timestamp) = extract(YEAR from b.key_period) and
	       extract(MONTH from c.weld_timestamp) = extract(MONTH from b.key_period) and
	       c."WeldVoltageActual" > b.voltage_up_2sig and
	       b.voltage_up_2sig > b.voltage_avg);

-- voltage low limit distance
update welds_70_current_stats a set voltage_low_limit_distance = 
	(select round((b.voltage_low_2sig - c."WeldVoltageActual")/abs(b.voltage_avg - b.voltage_low_2sig),6)
	 from weld_averages b, welds_70_datasets c
	 where a.fingerprint = c.fingerprint and
	       b.key_tool = c."uniqueID" and 
	       b.key_extension = c.extensionid and 
	       extract(YEAR from c.weld_timestamp) = extract(YEAR from b.key_period) and
	       extract(MONTH from c.weld_timestamp) = extract(MONTH from b.key_period) and
	       c."WeldVoltageActual" < b.voltage_low_2sig and
	       b.voltage_low_2sig < b.voltage_avg);

-- update offsigma distances:
update welds_70_current_stats set penetration_offsigma_distance = coalesce(penetration_up_limit_distance,-penetration_low_limit_distance,0);
update welds_70_current_stats set energy_offsigma_distance = coalesce(energy_up_limit_distance,-energy_low_limit_distance,0);
update welds_70_current_stats set drop_time_offsigma_distance = coalesce(drop_time_up_limit_distance,-drop_time_low_limit_distance,0);
update welds_70_current_stats set stickout_offsigma_distance = coalesce(stickout_up_limit_distance,-stickout_low_limit_distance,0);
update welds_70_current_stats set lift_offsigma_distance = coalesce(lift_up_limit_distance,-lift_low_limit_distance,0);
update welds_70_current_stats set time_offsigma_distance = coalesce(time_up_limit_distance,-time_low_limit_distance,0);
update welds_70_current_stats set current_offsigma_distance = coalesce(current_up_limit_distance,-current_low_limit_distance,0);
update welds_70_current_stats set voltage_offsigma_distance = coalesce(voltage_up_limit_distance,-voltage_low_limit_distance,0);

---------------------------------------------------
---------------------------------------------------
---------------------------------------------------
------- WELDS GLOBAL STATS
---------------------------------------------------
---------------------------------------------------
---------------------------------------------------
drop table if exists welds_70_global_stats;
create table welds_70_global_stats(
      fingerprint varchar(100),
      extensionid varchar(100),
      uniqueid varchar(100),
      avg_offsigma numeric,
      max_offsigma numeric,
      count_offsigma numeric,
      avg_avgdistance numeric,
      max_avgdistance numeric
);

insert into welds_70_global_stats (fingerprint,extensionid,uniqueid,avg_offsigma,max_offsigma,count_offsigma,avg_avgdistance,max_avgdistance)
select a.fingerprint, a.extensionid, a.uniqueid, 
       (a.penetration_offsigma_distance + a.energy_offsigma_distance + a.drop_time_offsigma_distance + a.stickout_offsigma_distance + a.lift_offsigma_distance + a.time_offsigma_distance + a.current_offsigma_distance + a.voltage_offsigma_distance) / 8 as avg_offsigma,
       greatest(a.penetration_offsigma_distance,a.energy_offsigma_distance,a.drop_time_offsigma_distance,a.stickout_offsigma_distance,a.lift_offsigma_distance,a.time_offsigma_distance,a.current_offsigma_distance,a.voltage_offsigma_distance) as max_offsigma,
       case when a.penetration_offsigma_distance > 0 then 1 else 0 end +
       case when a.energy_offsigma_distance > 0 then 1 else 0 end +
       case when a.drop_time_offsigma_distance > 0 then 1 else 0 end +
       case when a.stickout_offsigma_distance > 0  then 1 else 0 end +
       case when a.lift_offsigma_distance > 0 then 1 else 0 end +
       case when a.time_offsigma_distance > 0 then 1 else 0 end +
       case when a.current_offsigma_distance > 0 then 1 else 0 end +
       case when a.voltage_offsigma_distance > 0 then 1 else 0 end as count_offsigma,
       (a.penetration_avg_distance + a.energy_avg_distance + a.drop_time_avg_distance + a.stickout_avg_distance + a.lift_avg_distance + a.time_avg_distance + a.current_avg_distance + a.voltage_avg_distance)/ 8 as avg_avgdistance,
       greatest(a.penetration_avg_distance, a.energy_avg_distance, a.drop_time_avg_distance, a.stickout_avg_distance, a.lift_avg_distance, a.time_avg_distance, a.current_avg_distance , a.voltage_avg_distance) as max_avgdistance
from welds_70_current_stats a;




